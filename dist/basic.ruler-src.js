var Utils={capString:function(t){return t.substring&&t.length&&(t=t.substring(0,1).toUpperCase()+t.substring(1)),t},hasClass:function(t,e){var i=L.DomUtil.hasClass;for(var o in e)if(i(t,e[o]))return!0;return!1},beginClass:function(t,e){if(t.className&&e&&t.className.indexOf&&t.className.indexOf(e)!==-1)return!0},getIconLabelHtml:function(t,e){var i=['<span style="color: '+e+';">'+t+"</span>"].join("");return i},getLayerById:function(t){var e=null;return this.mainLayer.eachLayer(function(i){if(i.options.id===t)return void(e=i)}),e},setUpColor:function(){this.options.color.indexOf("#")===-1&&(this.options.color="#"+this.options.color),this.options.fillColor.indexOf("#")===-1&&(this.options.fillColor="#"+this.options.fillColor),this.includeColor(this.options.color),this.includeColor(this.options.fillColor)},includeColor:function(t){var e=!1;for(var i in this.options.pallette)this.options.pallette[i]===t&&(e=!0);e||this.options.pallette.push(t)}};!function(){L.Class.Feature=L.Class.extend({statics:{},includes:[Utils],initialize:function(t){L.Util.extend(this.options,t.options),this.options.color=t.options.color,this.core=t,this.a=t.a},destroy:function(){},isEnabled:function(){var t=this.options.name;return this[t+"Enable"]},enableFeature:function(){var t=this.options.name;this[t+"Enable"]=!0},disableFeature:function(){var t=this.options.name;this[t+"Enable"]=!1},resetFeature:function(){},onClick:function(t){this.core.layer||this.core.initLayer()},reorderFeatures:function(t,e){for(var i in e.featureList)if(e.featureList[i].options.name===t){e.featureList.splice(parseInt(i),1),e.featureList.unshift(this);break}},onDblClick:function(t){},onMove:function(t){},onDraw:function(t,e,i,o){},onRedraw:function(t,e,i){},onRenderNode:function(t,e,i){},onSelect:function(t){}})}(),function(){L.Class.ControlFeature=L.Class.Feature.extend({options:{type:"control"},initialize:function(t){L.Class.Feature.prototype.initialize.call(this,t);var e=this,i=this.options.name,o=this.disableFeature,n=this.enableFeature;this.capString(i),this.a=t.a,1===t.originalFeaturesCount?t.features[0]===this.options.name&&L.Class.Feature.prototype.enableFeature.call(this):(this.control=L.DomUtil.create("a","icon-"+i,t.container),this.control.href="#",this.control.title="",L.DomEvent.on(this.control,"click",function(){e[i+"Enable"]?o.call(e):n.call(e)})),this.options.type="control"},destroy:function(){this.control&&L.DomUtil.remove(this.control)},isEnabled:function(){var t=this.options.name;return this[t+"Enable"]},resetOtherControlFeatures:function(){var t=this.core.featureList;for(var e in t)"control"===t[e].options.type&&t[e].disableFeature()},enableFeature:function(){this.resetOtherControlFeatures(),L.Class.Feature.prototype.enableFeature.call(this),L.DomUtil.addClass(this.control,"sub-icon-active")},disableFeature:function(){L.Class.Feature.prototype.disableFeature.call(this),L.DomUtil.removeClass(this.control,"sub-icon-active")},onClick:function(t){this.core.layer.options.type=this.options.name,this.core.layer.options.title="Untitled",this.core.layer.options.description="...",this.core.selectedLayer=this.core.layer,L.Class.Feature.prototype.onClick.call(this,t);var e=t.originalEvent.target,i=t.originalEvent.target;return!(this.beginClass(i,["icon-"])||this.hasClass(i,["close"])||this.hasClass(i,["tip-layer"])||this.hasClass(i,["tip-input"])||this.hasClass(e,["leaflet-popup","total-popup-content"]))}})}();var Geo={repaintGeoJson:function(t){if(t){var e=t.options.id;this.mainLayer.removeLayer(t),this.deleteGeoJson(e),this.persistGeoJson(t,t.options.simple),this.plotGeoJsons(e)}},getGeoJsons:function(){return sessionStorage.geos?JSON.parse(sessionStorage.geos):[]},getGeoJson:function(t){var e=this.getGeoJsons();for(var i in e)if(e[i].properties.id===t)return e[i].index=parseInt(i),e[i];return null},deleteGeoJson:function(t){var e=this.getGeoJsons(),i=this.getGeoJson(t);i&&(e.splice(i.index,1),this.saveGeoJsons(e))},purgeGeoJsons:function(){this.saveGeoJsons([])},saveGeoJsons:function(t){t=JSON.stringify(t),sessionStorage.geos=t,this._map.fire("shape_changed")},updateGeoJson:function(t){this.deleteGeoJson(t.properties.id),this.insertGeoJson(t)},insertGeoJson:function(t){var e=this.getGeoJsons();e.push(t),this.saveGeoJsons(e)},persistGeoJson:function(t){var e,i,o=[],n=t.options.id?"update":"insert",a=t.options.id||(new Date).getTime();t.options.id=a,this.poly&&t.removeLayer(this.poly),t.eachLayer(function(t){i=t.toGeoJSON(),i.properties.styles=t.options,o.push(i)}),e={type:"FeatureCollection",properties:{id:a,hidden:!1,description:t.options.description,name:t.options.title,type:t.options.type,lastPoint:t.options.lastPoint},features:o},this[n+"GeoJson"](e)},plotGeoJsons:function(t){var e=this;this.resetRuler();var i,o,n=this.getGeoJsons(),a=function(t,i){var o;return o=t.properties.styles.label?e.nodeFeature.renderLabel(i,t.properties.styles.label,t.properties.styles,!1):e.nodeFeature.renderCircle(i,!1,!1,!1,!0,t.properties.styles)},s=function(t){return t.properties.styles},r=function(t){t.getLatLngs&&t};for(var l in n)t&&t!==n[l].properties.id||n[l].properties.hidden||(o=n[l].properties,i=L.geoJson(n[l],{id:o.id,pointToLayer:a,style:s,hidden:o.hidden,description:o.description,title:o.name,lastPoint:o.lastPoint,type:o.type}).addTo(this.mainLayer),i.eachLayer(r),o.lastPoint&&this.labelFeature.drawTooltip(o.lastPoint,i,o.name))}};!function(){L.Class.LabelFeature=L.Class.Feature.extend({options:{name:"label"},initialize:function(t,e){L.Class.Feature.prototype.initialize.call(this,t),this.enableFeature(),this.map=e},onClick:function(t,e){e&&this.onDblClick(t)},onDblClick:function(t){var e=this.core.layer,i=e.options.title,o=!1;e.eachLayer(function(t){o=!0}),o&&this.drawTooltip(t.latlng,e,i)},drawTooltip:function(t,e,i){e.options.lastPoint=t;var o=this.core.options.color,n=this.getIconHtml(i,o);e.totalIcon=L.divIcon({className:"total-popup",html:n}),e.total=L.marker(t,{icon:e.totalIcon,clickable:!0,total:!0,type:"label"}).addTo(e),this.drawTooltipHandlers({latlng:t},e,i)},getIconHtml:function(t,e){var i="#fff"===e?"black":"#fff",o=['<div class="total-popup-content" style="background-color:'+e+"; color: "+i+';">','  <input class="tip-input hidden-el" type="text" style="color: '+i+'" />','  <div class="tip-layer">'+t+"</div>",'  <svg class="close" viewbox="0 0 45 35">','   <path class="close" style="stroke:'+i+'" d="M 10,10 L 30,30 M 30,10 L 10,30" />',"  </svg>","</div>"].join("");return o},drawTooltipHandlers:function(t,e,i){var o=this,n=e,a=i?i:"Untitled",s="ruler"===e.options.type,r=(this.core._map,e.options.title.split(" ")),l={scalar:r[0],unit:r[1]};this.SUB_UNIT_CONV=1e3,"imperial"===this.options.unitSystem&&(this.SUB_UNIT_CONV=5280);var c={latlng:t.latlng,total:l,total_label:e.total,sub_unit:this.SUB_UNIT_CONV,workspace:n,rulerOn:s},p=function(t){var e=(new Date).getTime(),i=e-n.tik;return n.tik=e,i<300},u=function(t){var e=o.map;L.DomEvent.stop(t),p(t)&&h(),t.originalEvent&&L.DomUtil.hasClass(t.originalEvent.target,"close")&&(e.fire("shape_delete",{id:n.options.id}),e.fire("shape_changed"))},h=function(t){if(o.core.selectedLayer=n,s)return void n.fireEvent("selected",c);var i,r=(o.map,e),l="",p=e.total._icon.children[0],u=p.children,h=function(t){L.DomUtil.addClass(i,"hidden-el"),L.DomUtil.removeClass(l,"hidden-el"),e.options.title=i.value,o.core.persistGeoJson(e),i.removeEventListener("blur",h),i.removeEventListener("keyup",d)},d=function(t){var e=i.value;l.innerHTML=e||"&nbsp;",r.title=e||"",a=e||"","Enter"===t.key?h():(l.innerHTML=i.value||"&nbsp;",g=l.offsetWidth,i.style.width=g+"px")};for(var f in u){if(!u[f].nodeName)break;L.DomUtil.hasClass(u[f],"tip-layer")?(l=u[f],L.DomUtil.addClass(l,"hidden-el")):L.DomUtil.hasClass(u[f],"tip-input")&&(i=u[f],i.value=a,L.DomUtil.removeClass(i,"hidden-el"),i.addEventListener("keyup",d),i.addEventListener("blur",h),i.focus())}var g=l.offsetWidth;i.style.width=g+"px"};this.core.persistGeoJson(e),n.off("click"),n.on("click",u),n.on("selected",this.core.onSelect),n.is_new&&h()}})}(),!function(){L.Class.NapFeature=L.Class.Feature.extend({options:{name:"nap"},initialize:function(t){L.Class.Feature.prototype.initialize.call(this,t),this.enableFeature();var e=this;setTimeout(function(){e.reorderFeatures("nap",t)},1e3)},onClick:function(t){this.checkSorroundings(t)},onMove:function(t){this.checkSorroundings(t)},checkSorroundings:function(t){var e=this,i=this.core.mainLayer;i.eachLayer(function(i){e.checkLayer(i,t)})},checkLayer:function(t,e){t.eachLayer(function(t){if("node"===t.options.type&&t.getLatLng().equals(e.latlng,.003))return e.latlng=t.getLatLng(),!0})}})}(),!function(){L.Class.DragFeature=L.Class.ControlFeature.extend({options:{name:"drag"},dx:0,dy:0,initialize:function(t){L.Class.ControlFeature.prototype.initialize.call(this,t);var e=this;setTimeout(function(){e.reorderFeatures("drag",t)},1e3)},enableFeature:function(){L.Class.ControlFeature.prototype.enableFeature.call(this),this.core._map.dragging.disable(),this.core.napFeature&&this.core.napFeature.disableFeature(),this.initialPreparation()},disableFeature:function(){L.Class.ControlFeature.prototype.disableFeature.call(this),this.core._map.dragging.enable(),this.core.napFeature&&this.core.napFeature.enableFeature(),this.cleanup()},onClick:function(t){if(L.DomUtil.hasClass(t.originalEvent.target,"icon-drag"))return!1},initialPreparation:function(){var t=this,e=this.core._map,i=function(e,i,o){var n=function(e){t.selectedLayer=o};"line"!==e.options.type&&"polygon"!==e.options.type||(e.fn=n,e.on("mousedown",n,t))};this.checkSorroundings({},i),e.on("mousedown",this.mapStartDrag,this),e.on("mousemove",this.mapDrag,this),e.on("mouseout",this.mapStopDrag,this),e.on("mouseup",this.mapStopDrag,this)},cleanup:function(){var t=this,e=this.core._map,i=function(e,i,o){"line"!==e.options.type&&"polygon"!==e.options.type||e.off("mousedown",e.fn,t)};this.checkSorroundings({},i),e.off("mousedown",this.mapStartDrag,this),e.off("mousemove",this.mapDrag,this),e.off("mouseout",this.mapDrag,this),e.off("mouseup",this.mapDrag,this)},mapStartDrag:function(t){var e=this;this.startDragging(t),this.selectedLayer||this.selectedNode||"path"===t.originalEvent.target.nodeName||(e.mapDragging=!0)},mapDrag:function(t){var e,i=this,o=7,n=i.core._map;i.mapDragging?(e=n.latLngToContainerPoint(n.getCenter()),e.x-=t.originalEvent.movementX*o,e.y-=t.originalEvent.movementY*o,n.setView(n.containerPointToLatLng(e))):(this.selectedLayer||this.selectedNode)&&this.dragLayer(t)},mapStopDrag:function(t){this.stopDragging(),this.mapDragging=!1},startDragging:function(t){var e,i=this,o=function(t,o,n){if("node"===t.options.type){if(t.getLatLng().equals(o.latlng,.003))return void(i.selectedNode=t)}else if(t.getLatLngs){e=t.getLatLngs(),"polygon"===t.options.type&&(e=e[0]);var a,s,r=i.getSegments(e),l=i.core._map.latLngToContainerPoint(o.latlng);for(var c in r)if(a=L.LineUtil.closestPointOnSegment(l,r[c][0],r[c][1]),s=i.core._map.containerPointToLatLng(a),s.equals(o.latlng,.003))return void(i.selectedLayer=n)}};this.checkSorroundings(t,o)},getSegments:function(t){var e,i,o=[];for(var n in t)i=this.core._map.latLngToContainerPoint(t[n]),e&&o.push([e,i]),e=i;return o},stopDragging:function(t){this.selectedNode=null,this.selectedLayer=null,this.core._map.off("mousemove",this.dragLayer,this),this.core._map.off("mouseup",this.stopDragging,this)},dragLayer:function(t){var e=this;if(this.dx=t.originalEvent.movementX,this.dy=t.originalEvent.movementY,this.selectedNode&&"node"===this.selectedNode.options.type){var i=this.selectedNode.getLatLng();this.selectedNode.setLatLng(t.latlng),this.findNodeLines(i,t.latlng)}else if(this.selectedLayer){var e=this,o=(new L.Transformation(this.dx,1,this.dy,1),this.selectedLayer);o.eachLayer(function(t){if("line"===t.options.type||"polygon"===t.options.type){var i,o=t.getLatLngs();"polygon"===t.options.type&&(o=o[0]);for(var n in o)i=e.core._map.latLngToContainerPoint(o[n]),i.x+=e.dx,i.y+=e.dy,o[n]=e.core._map.containerPointToLatLng(i);t.setLatLngs(o)}else t.getLatLng&&(i=e.core._map.latLngToContainerPoint(t.getLatLng()),i.x+=e.dx,i.y+=e.dy,t.setLatLng(e.core._map.containerPointToLatLng(i)))})}},findNodeLines:function(t,e){var i=this,o=function(t,o,n){var a,s=[];if("line"===t.options.type||"polygon"===t.options.type){s=t.getLatLngs(),"polygon"===t.options.type&&(s=s[0]);for(var r in s)if(s[r].equals(o)){s[r].lat=e.lat,s[r].lng=e.lng;break}t.setLatLngs(s),"ruler"===t.options.stype?(i.core.rulerFeature.layer=n,i.core.rulerFeature.latlngs=s,i.core.rulerFeature.clearAll(n),i.core.rulerFeature.drawRulerLines(n,null),i.core.rulerFeature.layer=null,i.core.rulerFeature.latlngs=null):i.core.lineFeature.clearAll(n),a=s[s.length-1],i.core.labelFeature.drawTooltip(a,n,n.options.title)}};this.checkSorroundings(t,o)},checkSorroundings:function(t,e){var i=this,o=this.core.mainLayer;o&&o.eachLayer(function(o){i.checkLayerGroup(o,t,e)})},checkLayerGroup:function(t,e,i){t.eachLayer(function(o){i&&i(o,e,t)})}})}(),!function(){L.Class.NodeFeature=L.Class.ControlFeature.extend({options:{name:"node"},onClick:function(t){var e=L.Class.ControlFeature.prototype.onClick.call(this,t);if(e){if(L.DomUtil.hasClass(t.originalEvent.target,"icon-node"))return!1;this.renderCircle(t.latlng,this.core.layer,"node","",!0)}return e},renderCircle:function(t,e,i,o,n,a){var s=this.options.color,r=this.core.options,l=3;i=i||"circle","node"!=i&&(l=1,s="blue","dot"===i&&(s="white"));var r=a||{color:s,opacity:r.opacity,fillOpacity:r.fillOpacity,weight:r.weight,fill:r.fill,fillColor:r.fillColor,type:i},c=L.circleMarker(t,r);return c.setRadius(l),e&&c.addTo(e),n||this.renderLabel(t,o,r,e),c},renderLabel:function(t,e,i,o){var n,a=i.type,s=this.options.color,r=this.core._map.latLngToContainerPoint(t),l=this.core._map.containerPointToLatLng(r);if("dot"===i.type&&(s="blue"),e){var c=L.divIcon({className:"dot"===i.type?"total-popup-label-dot":"total-popup-label",html:this.getIconLabelHtml(e,s)});n=L.marker(l,{icon:c,type:a,label:e}),i.label=e,o&&n.addTo(o)}return n}})}(),!function(){L.Class.LineFeature=L.Class.NodeFeature.extend({options:{name:"line",doubleClickSpeed:300},latlngs:[],onClick:function(t){var e=L.Class.NodeFeature.prototype.onClick.call(this,t);if(e){if(L.DomUtil.hasClass(t.originalEvent.target,"icon-line"))return!1;this.latlngs.push(t.latlng)}return e},onMove:function(t,e){if(this.latlngs.length){var i=(this.core,this.latlngs.concat([t.latlng]));this.poly?this.poly.setLatLngs(i):"polygon"===this.options.name?this.poly=this.renderPolygon(i,e):this.poly=this.renderPolyline(i,e)}},onDblClick:function(t){this.poly=null,this.latlngs.length=0},renderPolyline:function(t,e){var i=this.core.options,o=L.polyline(t,{color:i.color,fill:"polygon"===e.options.type?i.fill:"",fillColor:i.fillColor,stroke:i.stroke,opacity:i.opacity,fillOpacity:i.fillOpacity,weight:i.weight,dashArray:i.dashArray,type:"line"});return o.addTo(e),o},renderPolygon:function(t,e){var i=this.core.options,o=L.polygon(t,{color:i.color,fill:"polygon"===e.options.type?i.fill:"",fillColor:i.fillColor,stroke:i.stroke,opacity:i.opacity,fillOpacity:i.fillOpacity,weight:i.weight,dashArray:i.dashArray,type:"polygon"});return o.addTo(e),o},clearAll:function(t){t&&t.eachLayer(function(e){(e.options&&"tmp"===e.options.type||"fixed"===e.options.type||"label"===e.options.type)&&t.removeLayer(e)})}})}(),!function(){L.Class.PolyFeature=L.Class.LineFeature.extend({options:{name:"polygon"},onClick:function(t){return!L.DomUtil.hasClass(t.originalEvent.target,"icon-polygon")&&L.Class.LineFeature.prototype.onClick.call(this,t)}})}(),!function(){L.Class.RulerFeature=L.Class.LineFeature.extend({options:{name:"ruler"},initialize:function(t){L.Class.LineFeature.prototype.initialize.call(this,t),this.resetRuler()},enableFeature:function(){L.Class.LineFeature.prototype.enableFeature.call(this),this.core.napFeature&&this.core.napFeature.disableFeature()},disableFeature:function(){L.Class.LineFeature.prototype.disableFeature.call(this),this.core.napFeature&&this.core.napFeature.enableFeature()},onClick:function(t){L.DomUtil.hasClass(t.originalEvent.target,"icon-ruler")||L.Class.LineFeature.prototype.onClick.call(this,t)},onMove:function(t,e){L.Class.LineFeature.prototype.onMove.call(this,t,e),this.poly&&(this.poly.options.stype="ruler"),this.drawRulerLines(e,t)},onDblClick:function(t){this.fixMeasurements(this.core.layer),this.latlngs,this.core.layer.options.title=this.measure.scalar+" "+this.measure.unit,L.Class.LineFeature.prototype.onDblClick.call(this,t)},drawRulerLines:function(t,e){if(this.latlngs.length){var i,o=e?this.latlngs.concat([e.latlng]):this.latlngs,n=0,a=0,s=!1;if(n=this.getStaticSum(o),this.cleanUpTmp(t),o.length>1)for(var r in o)s=o[r].equals(o[o.length-1]),i&&(a+=this.displayMarkers.apply(this,[[i,o[r]],!0,a,t,n,s])),i=o[r]}},displayMarkers:function(t,e,i,o,n,a){var s,r,l,c,p,u,h,d=t[1],f=t[0],g=f.distanceTo(d)/this.UNIT_CONV,y=g,m=o.measure||this.measure,v=this.core._map.latLngToContainerPoint(d),C=this.core._map.latLngToContainerPoint(f),b=1,k=n,F=!0;n>1?(m.unit=this.UNIT,F=!1):(F=!0,m.unit=this.SUB_UNIT,k=this.SUB_UNIT_CONV*n),h=this.getSeparation(k,F),m.scalar=k.toFixed(2),m.unit===this.SUB_UNIT&&(b=this.SUB_UNIT_CONV,y*=b);for(var D=i*b+y,U=i*b,S=m.unit,E=Math.floor(U);E<D;E++)c=(D-E)/y,E%h||E<U||(s=v.x-c*(v.x-C.x),r=v.y-c*(v.y-C.y),p=L.point(s,r),u=this.core._map.containerPointToLatLng(p),l=E+" "+S,E&&this.renderCircle(u,o,"tmp",l,!1,!1),this.last=D);if(!a){var N=(U+g).toFixed(2)+" "+S;this.renderCircle(d,o,"dot",N,!1,!1)}return g},getSeparation:function(t,e){var i=(parseInt(t)+"").length,o=Math.pow(10,i),n=5,a=o/10;return e&&(n=2),5*a>t&&(a=parseInt(a/n)),a},getStaticSum:function(t){var e=0;if(t.length)if(t[0].length)for(var i in t)e+=this.countLine(t[i]);else e=this.countLine(t);else e=this.sum;return e},countLine:function(t){var e,i,o=0;for(var n in t)e=t[n],i&&(o+=i.distanceTo(e)/this.UNIT_CONV),i=t[n];return o},resetRuler:function(){this.sum=0,this.distance=0,this.separation=1,this.last=0,this.fixedLast=0,this.totalIcon=null,this.total=null,this.lastCircle=null,this.UNIT_CONV=1e3,this.SUB_UNIT_CONV=1e3,this.UNIT="km",this.SUB_UNIT="m","imperial"===this.options.unitSystem&&(this.UNIT_CONV=1609.344,this.SUB_UNIT_CONV=5280,this.UNIT="mi",this.SUB_UNIT="ft"),this.measure={scalar:0,unit:this.SUB_UNIT}},clearAll:function(t){t&&t.eachLayer(function(e){!e.options||"dot"!==e.options.type&&"tmp"!==e.options.type&&"fixed"!==e.options.type&&"label"!==e.options.type||t.removeLayer(e)})},cleanUpTmp:function(t){t&&t.eachLayer(function(e){!e.options||"dot"!==e.options.type&&"tmp"!==e.options.type||t.removeLayer(e)})},fixMeasurements:function(t){t&&t.eachLayer(function(t){"tmp"===t.options.type&&(t.options.type="fixed")})}})}(),!function(){L.Class.StyleFeature=L.Class.ControlFeature.extend({options:{name:"style",pallette:["#FF0080","#4D90FE","red","blue","green","orange","black"],dashArrayOptions:["5, 5","5, 10","10, 5","5, 1","1, 5","0.9","15, 10, 5","15, 10, 5, 10","15, 10, 5, 10, 15","5, 5, 1, 5"]},enableFeature:function(){L.Class.ControlFeature.prototype.enableFeature.call(this),this.buildPaintPane()},disableFeature:function(){L.Class.ControlFeature.prototype.disableFeature.call(this),this.disablePaint()},enablePaint:function(){this.paintPane?L.DomUtil.removeClass(this.paintPane,"hidden-el"):this.buildPaintPane()},disablePaint:function(){this.paintPane&&L.DomUtil.addClass(this.paintPane,"hidden-el")},onPaintChange:function(t){this.affectSelectedLayer(t)},affectSelectedLayer:function(t){var e=this,i={};i[t]=e.core.options[t],this.core.selectedLayer&&(this.core.selectedLayer.eachLayer(function(o){if(o.setStyle)o.setStyle(i);else{var n=o.options.icon,a=i[t],s="";if(o.options.total&&"color"===t){s=e.core.selectedLayer.title;var r=e.getIconHtml(s,a);L.setOptions(n,{html:r}),o.setIcon(n)}else if("fixed"===o.options.type&&"color"===t){s=o.options.label;var r=e.getIconLabelHtml(s,a);L.setOptions(n,{html:r}),o.setIcon(n)}}}),this.core.persistGeoJson(this.core.selectedLayer,this.core.selectedLayer.options.simple))},getIconHtml:function(t,e){var i="#fff"===e?"black":"#fff",o=['<div class="total-popup-content" style="background-color:'+e+"; color: "+i+';">','  <input class="tip-input hidden-el" type="text" style="color: '+i+'" />','  <div class="tip-layer">'+t+"</div>",'  <svg class="close" viewbox="0 0 45 35">','   <path class="close" style="stroke:'+i+'" d="M 10,10 L 30,30 M 30,10 L 10,30" />',"  </svg>","</div>"].join("");return o},idealTextColor:function(t){var e=105,i=this.getRGBComponents(t),o=.299*i.R+.587*i.G+.114*i.B;return 255-o<e?"#000000":"#ffffff"},getRGBComponents:function(t){var e=t.substring(1,3),i=t.substring(3,5),o=t.substring(5,7);return{R:parseInt(e,16),G:parseInt(i,16),B:parseInt(o,16)}},buildPaintPane:function(){var t=this,e=this.core._map.getContainer();this.paintPane=L.DomUtil.create("div","paint-pane",e);var i=new L.Draggable(this.paintPane);i.enable(),this.buildPaneHeader(),this.buildPaneSection("color",function(){t.paintColor.addEventListener("click",function(e){if(L.DomEvent.stop(e),L.DomUtil.hasClass(e.target,"clickable")){var i="SPAN"===e.target.nodeName?e.target.parentElement:e.target,o=i.getAttribute("color"),n=i.parentElement,a=n.childNodes;for(var s in a)t.isElement(a[s])&&L.DomUtil.removeClass(a[s],"paint-color-selected");L.DomUtil.addClass(i,"paint-color-selected"),t.core.options.color=o,t.onPaintChange("color")}})}),this.buildPaneSection("fillColor",function(){t.paintFillColor.addEventListener("click",function(e){if(L.DomEvent.stop(e),L.DomUtil.hasClass(e.target,"clickable")){var i="SPAN"===e.target.nodeName?e.target.parentElement:e.target,o=i.getAttribute("color"),n=i.parentElement,a=n.childNodes;for(var s in a)t.isElement(a[s])&&L.DomUtil.removeClass(a[s],"paint-color-selected");L.DomUtil.addClass(i,"paint-color-selected"),t.core.options.fillColor=o,t.onPaintChange("fillColor")}})}),this.buildPaneSection("flags",function(){t.paintFlags.addEventListener("click",function(e){L.DomUtil.hasClass(e.target,"clickable")&&"INPUT"===e.target.nodeName&&(e.target.checked?(t.core.options[e.target.getAttribute("flag")]=!0,t.onPaintChange(e.target.getAttribute("flag"))):(t.core.options[e.target.getAttribute("flag")]=!1,t.onPaintChange(e.target.getAttribute("flag"))))})}),this.buildPaneSection("dashArray",function(){t.paintDashArray.addEventListener("click",function(e){if(L.DomEvent.stop(e),L.DomUtil.hasClass(e.target,"clickable")){var i="svg"===e.target.nodeName?e.target:e.target.parentElement,o=i.childNodes,n=Math.round((e.offsetY-10)/20);for(var a in o)(t.isElement(o[a])||o[a].nodeName)&&L.DomUtil.removeClass(o[a],"line-selected");var s=o[n];s&&(L.DomUtil.addClass(o[n],"line-selected"),t.core.options.dashArray=o[n].getAttribute("stroke-dasharray").replace(/,/g,""),t.onPaintChange("dashArray"))}})}),this.buildPaneSection("opacity",function(){t.paintOpacity.addEventListener("mousedown",function(e){L.DomEvent.stop(e),t.slidemove=!0}),t.paintOpacity.addEventListener("mousemove",function(e){L.DomEvent.stop(e),t.slidemove&&t.moveSlider(e)}),t.paintOpacity.addEventListener("mouseup",function(e){t.slidemove=!1,L.DomEvent.stop(e),t.moveSlider(e)}),t.paintOpacity.addEventListener("click",function(e){L.DomEvent.stop(e),t.moveSlider(e)})})},moveSlider:function(t){var e=this;if(L.DomUtil.hasClass(t.target,"clickable")&&"INPUT"===t.target.nodeName){var i=t.offsetX/t.target.clientWidth;"1"==t.target.getAttribute("step")&&(i*=10),t.target.value=i,e.core.options[t.target.getAttribute("flag")]=t.target.value,e.onPaintChange(t.target.getAttribute("flag"))}},buildPaneHeader:function(){var t=this,e=['<span>Styling Options</span><i class="close">x</i>'].join("");this.paintPaneHeader=L.DomUtil.create("div","paint-pane-header",this.paintPane),this.paintPaneHeader.innerHTML=e,this.paintPaneHeader.addEventListener("click",function(e){L.DomEvent.stop(e),"I"===e.target.nodeName&&t.disableFeature()})},buildPaneSection:function(t,e){var i=this.capString(t),o=this["build"+i+"Section"]();this["paint"+i]=L.DomUtil.create("div","paint-pane-section paint-pane-"+t,this.paintPane),this["paint"+i].innerHTML=o,e&&"function"==typeof e&&e()},buildColorSection:function(){var t=this.core.options.pallette,e="",i=[];for(var o in t)e=t[o]===this.core.options.color?"paint-color-selected":"",i.push('<li class="paint-color clickable '+e+'" color="'+t[o]+'"><span class="clickable" style="background-color: '+t[o]+';"></span></li>');var n=['<span class="section-header">Stroke</span>','<ul class="section-body paint-color-wrapper">',i.join(""),"</ul>"].join("");return n},buildFillColorSection:function(){var t=this.core.options.pallette,e="",i=[];for(var o in t)e=t[o]===this.core.options.fillColor?"paint-color-selected":"",i.push('<li class="paint-color clickable '+e+'" color="'+t[o]+'"><span class="clickable" style="background-color: '+t[o]+';"></span></li>');var n=['<span class="section-header">Fill Color</span>','<ul class="section-body paint-color-wrapper">',i.join(""),"</ul>"].join("");return n},buildFlagsSection:function(){var t=["stroke","fill"],e="",i=[];for(var o in t)e=this.core.options[t[o]]?"checked":"",i.push('<div><input value="'+t[o]+'" type="checkbox" '+e+' class="clickable" flag="'+t[o]+'"> Draw '+t[o]+"</div>");var n=['<span class="section-header">Options</span>','<div class="section-body">',i.join(""),"</div>"].join("");return n},buildDashArraySection:function(){var t=this.core.options.dashArrayOptions,e="",i=[],o=10;for(var n in t)e=this.core.options.dashArray===t[n]?"line-selected":"",i.push('<line class="clickable pain-lines '+e+'" stroke-dasharray="'+t[n]+'" x1="10" y1="'+o+'" x2="160" y2="'+o+'" />'),o+=20;var a=['<span class="section-header">Dash Array</span>','<svg class="section-body clickable" width="170" height="200" viewPort="0 0 200 160" version="1.1" xmlns="http://www.w3.org/2000/svg">',i.join(""),"</svg>"].join("");return a},buildOpacitySection:function(){var t=["opacity","fillOpacity","weight"],e=[],i=0,o=0;for(var n in t)"weight"===t[n]?(i=10,o=1):(i=1,o=.1),e.push('<span class="section-header">'+this.capString(t[n])+"</span>"),e.push('<div class="section-body">'),e.push(' <div><input value="'+this.core.options[t[n]]+'" type="range" min="0" max="'+i+'" step="'+o+'" class="clickable" flag="'+t[n]+'"></div>'),e.push("</div>");return e.join("")},isElement:function(t){try{return t instanceof HTMLElement}catch(e){return"object"==typeof t&&1===t.nodeType&&"object"==typeof t.style&&"object"==typeof t.ownerDocument}}})}(),!function(){L.Class.TrashFeature=L.Class.ControlFeature.extend({options:{name:"trash"},onClick:function(t){var e=this;this.core.mainLayer.eachLayer(function(t){e.core.mainLayer.removeLayer(t)}),this.core.purgeGeoJsons(),this.core._map.fire("shape_changed"),e.core.resetRuler(),setTimeout(function(){e.disableFeature()},100)}})}();var Handlers={onDblClick:function(t,e,i){var o,n=this;for(var a in this.featureList)o=this.featureList[a],o.isEnabled()&&o.onDblClick(t);n.reset(t)},getMouseClickHandler:function(t){var e=!1;if(this.layer||this.initLayer(),this.isDblClick())this.onDblClick(t);else{var i;for(var o in this.featureList)i=this.featureList[o],i.isEnabled()&&("node"===i.options.name&&(e=!0),i.onClick(t,e))}e&&this.reset(t)},getMouseMoveHandler:function(t){var e;for(var i in this.featureList)e=this.featureList[i],e.isEnabled()&&e.onMove(t,this.layer)},isDblClick:function(){var t=(new Date).getTime(),e=t-this.tik;return this.tik=t,e<this.options.doubleClickSpeed},onAdded:function(){},onSelect:function(t){}};!function(){var mixins=[Utils,Geo,Handlers];L.Control.LinearCore=L.Control.extend({options:{position:"topleft",color:"#4D90FE",fillColor:"#fff",features:["node","line","poly","ruler","nap","label","style","drag","trash"],pallette:["#FF0080","#4D90FE","red","blue","green","orange","black"],dashArrayOptions:["5, 5","5, 10","10, 5","5, 1","1, 5","0.9","15, 10, 5","15, 10, 5, 10","15, 10, 5, 10, 15","5, 5, 1, 5"],fill:!0,stroke:!0,dashArray:"5, 5",weight:2,opacity:1,fillOpacity:.5,radius:3,unitSystem:"imperial",doubleClickSpeed:300},includes:mixins,tik:0,onAdd:function(t){var e=L.DomUtil.create("div","leaflet-control leaflet-bar"),i=t.getContainer(),o=this,n="draw";return this.options.features&&1===this.options.features.length&&(n=o.options.features[0]),this.link=L.DomUtil.create("a","icon-"+n,e),this.link.href="#",this.link.title="",this.container=e,t.on("linear_feature_on",function(t){o.active||(o.active=!0,o.initRuler(e),L.DomUtil.addClass(o.link,"icon-active"),L.DomUtil.addClass(i,"ruler-map"))}),L.DomEvent.on(o.link,"click",L.DomEvent.stop).on(o.link,"click",function(){L.DomUtil.hasClass(o.link,"icon-active")?(o.active=!1,o.resetRuler(!0),L.DomUtil.removeClass(o.link,"icon-active"),L.DomUtil.removeClass(i,"ruler-map")):(o.active=!0,o.initRuler(e),L.DomUtil.addClass(o.link,"icon-active"),L.DomUtil.addClass(i,"ruler-map"))}),this.setUpColor(),this.onAdded(),e},onRemove:function(t){this.resetRuler(!0)},verifyFeatureName:function(t){var e=["node","label","nap","line","poly","ruler","style","trash","drag","trash"];if(this.featureMap[t])return!1;this.featureMap[t]=!0;for(var i in e)if(e[i]===t)return!0;return!1},initRuler:function(container){var me=this,map=this._map;this.featureMap={},this.features=[];for(var j in this.options.features)this.features.push(this.options.features[j]);this.featureList=[],this.originalFeaturesCount=this.features.length,1===this.originalFeaturesCount&&(this.features.push("node"),this.features.push("label"));var f;for(var i in this.features)f=this.features[i],this.verifyFeatureName(f)?(this[f+"Feature"]=eval("new L.Class."+this.capString(f)+"Feature(this, this._map)"),this.featureList.push(this[f+"Feature"])):console.log("One or more feature is invalid: "+f);this.mainLayer=L.featureGroup(),this.mainLayer.addTo(this._map),map.touchZoom.disable(),map.doubleClickZoom.disable(),map.boxZoom.disable(),map.keyboard.disable(),map.tap&&map.tap.disable(),this.dblClickEventFn=function(t){L.DomEvent.stop(t)},map.on("click",this.getMouseClickHandler,this),map.on("dblclick",this.dblClickEventFn,map),map.on("mousemove",this.getMouseMoveHandler,this),this.mainLayer.on("dblclick",this.dblClickEventFn,this.mainLayer),this.shapeInit(),this.plotGeoJsons()},initLayer:function(){this.layer=L.geoJson(),this.layer.is_new=!0,this.layer.tik=0,this.layer.options.type=this.options.type,this.layer.options.title="Untitled",this.layer.options.description="...",this.layer.addTo(this.mainLayer),this.layer.on("selected",this.onSelect)},resetRuler:function(t){var e=this._map;if(t){e.off("click",this.clickEventFn,this),e.off("mousemove",this.moveEventFn,this),e.off("dblclick",this.dblClickEventFn,e),this.mainLayer.off("dblclick",this.dblClickEventFn,this.mainLayer),this.layer&&e.removeLayer(this.layer),this.mainLayer&&e.removeLayer(this.mainLayer),this.mainLayer=null,e.touchZoom.enable(),e.boxZoom.enable(),e.keyboard.enable(),e.tap&&e.tap.enable();for(var i in this.featureList)this.featureList[i].destroy()}this.layer=null,this.originalLatLng=null,this.prevLatlng=null,this.poly=null,this.multi=null,this.latlngs=null,this.latlngsList=[],this.nodes=[]},reset:function(t){this.layer&&(this.layer.off("dblclick"),L.DomEvent.stop(t),this.layer.removeLayer(this.poly),this.resetRuler(!1))},shapeInit:function(){var t=this,e=this._map;e.on("shape_toggle",function(e){var i=e.id,o=t.getGeoJson(i),n=t.getLayerById(i);o.properties.hidden=e.hidden,t.updateGeoJson(o),n&&e.hidden?t.mainLayer.removeLayer(n):e.hidden||t.plotGeoJsons(i)}),e.on("shape_delete",function(e){var i=e.id,o=t.getLayerById(i);o&&(t.mainLayer.removeLayer(o),t.deleteGeoJson(i))}),e.on("shape_focus",function(i){var o=i.id,n=t.getLayerById(o);n&&(t.selectedLayer=n,e.setView(n.getBounds().getCenter()))}),e.on("shape_update",function(e){var i=e.id,o=t.getGeoJson(i),n=t.getLayerById(i);t.mainLayer.removeLayer(n),o.properties.hidden=e.hidden,o.properties.name=e.name,o.properties.description=e.description,t.updateGeoJson(o),e.hidden||t.plotGeoJsons(i)})}})}();